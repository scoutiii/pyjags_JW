name: Build (sdist + wheel)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }} / Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-13]
        python-version: ["3.11", "3.12", "3.13"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install JAGS (micromamba)
        uses: mamba-org/setup-micromamba@v2
        with:
          environment-name: jags
          condarc: |
            channels:
              - conda-forge
              - defaults
          create-args: >-
            python=${{ matrix.python-version }}
            jags
            pkg-config

      # ---- sanity: verify JAGS is discoverable via pkg-config inside the env
      - name: Check JAGS via pkg-config (sanity)
        shell: bash {0}
        run: |
          set -euxo pipefail
          micromamba run -n jags bash -lc '
            which pkg-config
            pkg-config --modversion jags
            pkg-config --cflags --libs jags
            echo "CONDA_PREFIX=$CONDA_PREFIX"
          '

      # ---- build sdist + wheel INSIDE the micromamba env
      - name: Build sdist + wheel (inside env, verbose)
        shell: bash {0}
        run: |
          set -euxo pipefail
          micromamba run -n jags bash -lc '
            # help CMake/pkg-config locate JAGS in this env
            export PKG_CONFIG_PATH="$CONDA_PREFIX/lib/pkgconfig"
            export CMAKE_PREFIX_PATH="$CONDA_PREFIX"
            export CPPFLAGS="-I$CONDA_PREFIX/include ${CPPFLAGS:-}"
            export LDFLAGS="-L$CONDA_PREFIX/lib ${LDFLAGS:-}"
            python -m pip install -U pip build
            python -m build
            ls -l dist
            test -n "$(ls dist/*.whl 2>/dev/null)" || { echo "No wheel built"; exit 1; }
          '

      # ---- Linux: repair wheels with auditwheel (still inside the env so libjags is visible)
      - name: Repair wheel (Linux)
        if: runner.os == 'Linux'
        shell: bash {0}
        run: |
          set -euxo pipefail
          micromamba run -n jags bash -lc '
            python -m pip install -U auditwheel
            for whl in dist/*.whl; do
              auditwheel show "$whl" || true
              auditwheel repair -w wheelhouse "$whl"
            done
            ls -l wheelhouse
          '

      # ---- macOS: delocate to vendor libjags.dylib into the wheel
      - name: Repair wheel (macOS)
        if: runner.os == 'macOS'
        shell: bash {0}
        run: |
          set -euxo pipefail
          micromamba run -n jags bash -lc '
            python -m pip install -U delocate
            delocate-listdeps dist/*.whl || true
            delocate-wheel -w wheelhouse dist/*.whl
            delocate-listdeps wheelhouse/*.whl
          '

      # ---- Optional: prove the wheel is self-contained outside conda
      - name: Sanity import test (repaired wheel only)
        shell: bash {0}
        run: |
          set -euxo pipefail
          python -m venv venv
          source venv/bin/activate
          # simulate a clean machine (no conda paths)
          unset CONDA_PREFIX CONDA_DEFAULT_ENV MAMBA_ROOT_PREFIX PKG_CONFIG_PATH DYLD_LIBRARY_PATH LD_LIBRARY_PATH
          python -m pip install --upgrade pip
          # prefer repaired wheels; fall back to dist if repair produced none (shouldn't happen)
          whl="$(ls wheelhouse/*.whl 2>/dev/null || true)"
          if [ -z "$whl" ]; then whl="$(ls dist/*.whl | head -n1)"; fi
          python -m pip install "$whl"
          python - <<'PY'
          import pyjags, sys
          print("OK import:", pyjags.__file__)
          PY

      - name: Upload artifacts (repaired wheels + sdist)
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            wheelhouse/*.whl
            dist/*.tar.gz
          if-no-files-found: error
